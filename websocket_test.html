<!DOCTYPE html>
<html>
<head>
    <title>WebSocket Chat Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
        }
        #messages {
            border: 1px solid #ccc;
            height: 400px;
            overflow-y: auto;
            padding: 10px;
            margin-bottom: 10px;
            background-color: #f9f9f9;
        }
        .message {
            margin: 5px 0;
            padding: 5px;
            border-bottom: 1px solid #eee;
        }
        .sender {
            font-weight: bold;
            color: #0066cc;
        }
        .timestamp {
            font-size: 0.8em;
            color: #666;
        }
        .error {
            color: red;
            font-weight: bold;
        }
        #messageInput {
            width: 70%;
            padding: 10px;
            font-size: 14px;
        }
        button {
            padding: 10px 20px;
            font-size: 14px;
            cursor: pointer;
        }
        .status {
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 4px;
        }
        .connected {
            background-color: #d4edda;
            color: #155724;
        }
        .disconnected {
            background-color: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>
    <h1>WebSocket Chat Test</h1>
    
    <div id="status" class="status disconnected">Disconnected</div>
    
    <div id="messages"></div>
    
    <input type="text" id="messageInput" placeholder="Type a message..." />
    <button onclick="sendMessage()">Send</button>
    
    <script>
        // Configuration - CHANGE THESE VALUES
        const CHAT_ID = 1;  // Change to your chat ID
        const WS_URL = `ws://localhost:8000/ws/chat/${CHAT_ID}/`;
        
        let socket = null;
        
        function updateStatus(connected) {
            const statusDiv = document.getElementById('status');
            if (connected) {
                statusDiv.className = 'status connected';
                statusDiv.textContent = 'Connected to chat room';
            } else {
                statusDiv.className = 'status disconnected';
                statusDiv.textContent = 'Disconnected';
            }
        }
        
        function addMessage(sender, content, timestamp, isError = false) {
            const messagesDiv = document.getElementById('messages');
            const messageElement = document.createElement('div');
            messageElement.className = 'message';
            
            if (isError) {
                messageElement.innerHTML = `<span class="error">Error: ${content}</span>`;
            } else {
                const time = new Date(timestamp).toLocaleString();
                messageElement.innerHTML = `
                    <span class="sender">${sender}</span>
                    <span class="timestamp">(${time})</span>: 
                    ${content}
                `;
            }
            
            messagesDiv.appendChild(messageElement);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
        
        function connectWebSocket() {
            socket = new WebSocket(WS_URL);
            
            socket.onopen = function(e) {
                console.log('WebSocket connection established');
                updateStatus(true);
                addMessage('System', 'Connected to chat room', new Date().toISOString());
            };
            
            socket.onmessage = function(event) {
                const data = JSON.parse(event.data);
                console.log('Received:', data);
                
                if (data.type === 'message') {
                    const msg = data.message;
                    addMessage(
                        msg.sender.username,
                        msg.content,
                        msg.timestamp
                    );
                } else if (data.type === 'error') {
                    addMessage('', data.message, new Date().toISOString(), true);
                }
            };
            
            socket.onerror = function(error) {
                console.error('WebSocket error:', error);
                addMessage('', 'WebSocket error occurred', new Date().toISOString(), true);
            };
            
            socket.onclose = function(event) {
                console.log('WebSocket connection closed');
                updateStatus(false);
                addMessage('System', 'Disconnected from chat room', new Date().toISOString());
                
                // Try to reconnect after 3 seconds
                setTimeout(connectWebSocket, 3000);
            };
        }
        
        function sendMessage() {
            const input = document.getElementById('messageInput');
            const content = input.value.trim();
            
            if (!content) {
                alert('Please enter a message');
                return;
            }
            
            if (!socket || socket.readyState !== WebSocket.OPEN) {
                alert('Not connected to chat');
                return;
            }
            
            socket.send(JSON.stringify({
                content: content
            }));
            
            input.value = '';
        }
        
        // Send message on Enter key
        document.getElementById('messageInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
        
        // Connect on page load
        connectWebSocket();
        
        // Instructions
        console.log('=== WebSocket Chat Test ===');
        console.log('1. Make sure you are logged in via REST API first');
        console.log('2. Change CHAT_ID in the HTML file to your chat ID');
        console.log('3. The connection will use your session cookie automatically');
    </script>
</body>
</html>
